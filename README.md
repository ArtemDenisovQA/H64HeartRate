# H64HeartRate

Пэт-проект на **Swift / SwiftUI** для **macOS**, который подключается к нагрудному датчику пульса **Magene H64** по **Bluetooth Low Energy (BLE)** и отображает:
- текущий пульс (**BPM**)
- статус подключения
- имя подключенного устройства

Проект использует стандартный BLE-профиль **Heart Rate Service (0x180D)** и характеристику **Heart Rate Measurement (0x2A37, Notify)**.

---

## Возможности

- ✅ Сканирование BLE-устройств с сервисом Heart Rate (0x180D)
- ✅ Подключение к датчику и подписка на уведомления (Notify) 2A37
- ✅ Парсинг Heart Rate Measurement (uint8/uint16 по флагу)
- ✅ Отображение BPM в реальном времени
- ✅ Отображение имени устройства
- ✅ Отображение батареи (если датчик рекламирует Battery Service 0x180F)
- ✅ Кнопки Start/Stop

---

## Требования

- macOS **13.7.8** (и выше, вероятно тоже ок)
- Xcode **15.2**
- Датчик пульса **Magene H64** (или другой BLE HRM, который поддерживает Heart Rate Service 0x180D)

---

## Установка и запуск

1) Склонируйте репозиторий:

```bash
git clone <URL вашего репозитория>
cd H64HeartRate
```

2) Откройте проект в Xcode:

- Откройте файл `H64HeartRate.xcodeproj` двойным кликом  
  или через Xcode: **File → Open…**

3) Запустите:

- В Xcode нажмите **Run (▶)**

---

## Как пользоваться

1) Наденьте ремень датчика (H64 может “спать”, пока нет контакта с телом).  
2) Убедитесь, что датчик **не подключен** к другому приложению/устройству (BLE часто допускает только одно подключение).
3) Запустите приложение.
4) Должны появиться статусы: `Сканирование… → Найдено… → Подключено… → Пульс обновляется`, затем число BPM.

Кнопки:
- **Старт** — начать сканирование/подключение
- **Стоп** — остановить сканирование, отключиться и сбросить значения

---

## Разрешения (важно)

Проект использует CoreBluetooth, поэтому нужны:

### Info.plist
Добавлено описание использования Bluetooth:
- `Privacy - Bluetooth Always Usage Description`

### App Sandbox
Включено:
- `App Sandbox → Bluetooth`

---

## Архитектура / как это работает (кратко)

- `HeartRateCentral.swift` — BLE-логика (Central):
  - создаёт `CBCentralManager`
  - запускает `scanForPeripherals(withServices: [180D])`
  - подключается к найденному `CBPeripheral`
  - ищет сервис `180D` и характеристику `2A37`
  - включает `setNotifyValue(true, for: 2A37)`
  - парсит уведомления и публикует `bpm` через `@Published`

- `ContentView.swift` — UI на SwiftUI:
  - подписывается на `HeartRateCentral` через `@StateObject`
  - отображает статус, имя устройства и BPM

Подробное описание потока событий — в файле:
- `H64HeartRate_BLE_event_flow.txt`

---

## Структура проекта

- `H64HeartRateApp.swift` — точка входа приложения SwiftUI
- `ContentView.swift` — UI (статус/имя/BPM + кнопки)
- `HeartRateCentral.swift` — CoreBluetooth логика и парсинг 2A37
- `H64HeartRate_BLE_event_flow.txt` — описание потока событий CoreBluetooth

---

## Известные ограничения

- Сейчас приложение подключается к **первому найденному** HRM-устройству с сервисом 0x180D.  
  Если рядом несколько датчиков, логично добавить список устройств и выбор нужного.
- При разрыве соединения выполняется авто-переподключение (если это включено в коде). Это можно сделать опциональным.

---

## Идеи для развития

- Список найденных устройств и выбор конкретного датчика
- Индикация “подключено/не подключено” отдельным флагом
- Логирование BPM в CSV/JSON
- График BPM в реальном времени


---

## Contributing

Это учебный пэт-проект. PR/идеи приветствуются:
1) форк
2) ветка `feature/...`
3) PR в `main`

---

## Лицензия

Пока не задана. Если планируете открыть проект — часто выбирают MIT/Apache-2.0.

---

## Автор

Artem Denisov
